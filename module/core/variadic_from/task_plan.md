# Task Plan: Refactor `variadic_from` and `variadic_from_meta` to comply with `spec.md` v1.1

### Goal
*   Refactor the `variadic_from` and `variadic_from_meta` crates to align with `spec.md` v1.1. This involves a significant overhaul of the derive macro using `macro_tools`, creating a new, robust test suite, and updating all related documentation. The goal is to ensure the macro is robust, maintainable, and adheres to modern Rust best practices and the specified architectural guidelines.

### Ubiquitous Language (Vocabulary)
*   **`VariadicFrom`:** The derive macro being implemented, allowing structs to be constructed from a variable number of arguments.
*   **`FromN` traits:** Custom traits (`From1`, `From2`, `From3`) generated by the macro, enabling construction from 1, 2, or 3 arguments respectively.
*   **`From<Tuple>`:** The standard `From` trait implementation for converting from tuples, generated by the macro.
*   **Convenience `FromN`:** Additional `FromN` implementations generated when field types are identical, allowing construction with fewer arguments (e.g., `From1` for a 2-field struct where both fields have the same type).
*   **`macro_tools`:** A helper crate used for procedural macro development, providing utilities for parsing and code generation.
*   **`StructLike`:** A utility from `macro_tools` that provides a unified way to access fields of named and tuple structs.
*   **`spec.md` v1.1:** The specification document outlining the desired behavior and architecture for the `VariadicFrom` macro.
*   **Primary Editable Crate:** `module/core/variadic_from`
*   **Additional Editable Crate:** `module/core/variadic_from_meta` (the procedural macro crate)
*   **External Crate:** `module/core/macro_tools` (a dependency that requires a temporary local patch for the `diag` feature).

### Progress
*   **Roadmap Milestone:** M1: Core API Implementation
*   **Primary Editable Crate:** `module/core/variadic_from`
*   **Overall Progress:** 6/7 increments complete
*   **Increment Status:**
    *   ✅ Increment 1: Audit, Cleanup, and Initial Setup
    *   ✅ Increment 2: Refactor Macro Input Parsing using `macro_tools`
    *   ✅ Increment 3: Implement Core `FromN` and `From<Tuple>` Generation
    *   ✅ Increment 4: Implement Conditional Convenience `FromN` Generation
    *   ✅ Increment 5: Implement and Validate the New Test Suite
    *   ✅ Increment 6: Implement Compile-Fail Tests
    *   ⚫ Increment 7: Finalization

### Permissions & Boundaries
*   **Mode:** code
*   **Run workspace-wise commands:** true
*   **Add transient comments:** true
*   **Additional Editable Crates:**
    *   `module/core/variadic_from_meta` (Reason: Procedural macro implementation)

### Relevant Context
*   Control Files to Reference (if they exist):
    *   `./roadmap.md`
    *   `./spec.md`
    *   `./spec_addendum.md`
*   Files to Include (for AI's reference, if `read_file` is planned):
    *   `module/core/variadic_from/src/lib.rs`
    *   `module/core/variadic_from/src/variadic.rs`
    *   `module/core/variadic_from_meta/src/lib.rs`
    *   `module/core/variadic_from/tests/inc/mod.rs`
    *   `module/core/variadic_from/tests/inc/derive_test.rs`
    *   `module/core/variadic_from_meta/Cargo.toml`
    *   `module/core/macro_tools/Cargo.toml`
*   Crates for Documentation (for AI's reference, if `read_file` on docs is planned):
    *   `variadic_from`
    *   `variadic_from_meta`
*   External Crates Requiring `task.md` Proposals (if any identified during planning):
    *   `module/core/macro_tools` (Reason: Need to enable `diag` feature for `macro_tools` to resolve compilation issues with `syn_err!` and `return_syn_err!`. A temporary local patch was applied, which will be reverted in the final increment.)

### Expected Behavior Rules / Specifications
*   The `VariadicFrom` derive macro should generate `FromN` implementations for structs with 1, 2, or 3 fields.
*   It should generate `From<Tuple>` implementations that delegate to the `FromN` methods.
*   It should generate convenience `From1` for 2-field and 3-field structs with identical types.
*   It should generate convenience `From2` for 3-field structs where the last two fields have identical types.
*   The macro should handle named and tuple structs correctly.
*   The macro should handle generic parameters correctly.
*   The macro should produce compile errors for structs with 0 or more than 3 fields.
*   The `from!` macro should produce compile errors when invoked with too many arguments.
*   All generated code must adhere to Rust's ownership and borrowing rules, especially for types like `String`.

### Crate Conformance Check Procedure
*   1. Run Tests: For `variadic_from` and `variadic_from_meta`, execute `timeout 90 cargo test -p {crate_name} --all-targets`.
*   2. Analyze Test Output: If any test command fails, initiate the `Critical Log Analysis Procedure`.
*   3. Run Linter: For `variadic_from` and `variadic_from_meta`, execute `timeout 90 cargo clippy -p {crate_name} -- -D warnings`.
*   4. Analyze Linter Output: If any linter command fails, initiate the `Linter Fix & Regression Check Procedure`.
*   5. Perform Output Cleanliness Check: Execute `cargo clean -p {crate_name}` followed by `timeout 90 cargo build -p {crate_name}`. Critically analyze the build output for any unexpected debug prints from procedural macros. If any are found, the check fails; initiate `Critical Log Analysis`.

### Increments
##### Increment 1: Audit, Cleanup, and Initial Setup
*   **Goal:** Audit the existing `variadic_from` and `variadic_from_meta` crates, clean up old test files, and restructure the `variadic` module into its own file.
*   **Specification Reference:** N/A (Initial setup/refactoring)
*   **Steps:**
    *   Step 1: Delete `module/core/variadic_from/tests/test.rs`.
    *   Step 2: Delete `module/core/variadic_from/tests/inc/mod.rs`.
    *   Step 3: Move the `variadic` module content from `module/core/variadic_from/src/lib.rs` to a new file `module/core/variadic_from/src/variadic.rs`.
    *   Step 4: Update `module/core/variadic_from/src/lib.rs` to declare `mod variadic;` and `pub use variadic::*;`.
    *   Step 5: Update paths within the `from!` macro in `module/core/variadic_from/src/variadic.rs` to use `crate::variadic_from_meta::VariadicFrom` instead of `crate::VariadicFrom`.
    *   Step 6: Create `module/core/variadic_from/tests/inc/mod.rs` with `pub mod derive_test;` and `use test_tools::exposed::*;`.
    *   Step 7: Perform Increment Verification.
    *   Step 8: Perform Crate Conformance Check.
*   **Increment Verification:**
    *   Execute `timeout 90 cargo build --workspace` via `execute_command` and analyze output to ensure successful compilation.
*   **Commit Message:** feat(variadic_from): Initial audit, cleanup, and module restructuring

##### Increment 2: Refactor Macro Input Parsing using `macro_tools`
*   **Goal:** Refactor the `VariadicFromContext` struct and its `new` function in `variadic_from_meta/src/lib.rs` to leverage `macro_tools` utilities for robust input parsing.
*   **Specification Reference:** `spec.md` v1.1 - "Macro Input Parsing"
*   **Steps:**
    *   Step 1: Modify `module/core/variadic_from_meta/Cargo.toml` to add `macro_tools` as a dependency with `enabled`, `struct_like`, `generic_params`, `typ`, and `diag` features.
    *   Step 2: Temporarily modify `module/core/macro_tools/Cargo.toml` to include `diag` in its `enabled` feature list to resolve internal compilation issues. (This will be reverted in the final increment).
    *   Step 3: Refactor `VariadicFromContext::new` in `module/core/variadic_from_meta/src/lib.rs` to use `syn::Data::Struct` and `syn::Fields::Named`/`syn::Fields::Unnamed` directly for field extraction, and `syn::Index::from(i).to_token_stream()` for tuple field indices.
    *   Step 4: Implement `constructor` and `constructor_uniform` methods in `VariadicFromContext` to generate appropriate struct instantiation syntax for both named and tuple structs.
    *   Step 5: Perform Increment Verification.
    *   Step 6: Perform Crate Conformance Check.
*   **Increment Verification:**
    *   Execute `timeout 90 cargo build -p variadic_from_meta` via `execute_command` and analyze output to ensure successful compilation of the macro crate.
*   **Commit Message:** feat(variadic_from_meta): Refactor macro input parsing with `macro_tools`

##### Increment 3: Implement Core `FromN` and `From<Tuple>` Generation
*   **Goal:** Implement the core logic within `variadic_from_meta/src/lib.rs` to generate `FromN` traits (`From1`, `From2`, `From3`) and `From<Tuple>` implementations, ensuring the latter delegates to the `FromN` methods.
*   **Specification Reference:** `spec.md` v1.1 - "Core `FromN` Implementations", "Standard `From` Trait Integration"
*   **Steps:**
    *   Step 1: Implement `generate_from_n_impls` function in `module/core/variadic_from_meta/src/lib.rs` to generate `From1`, `From2`, and `From3` trait implementations based on the number of fields.
    *   Step 2: Implement `generate_from_tuple_impl` function in `module/core/variadic_from_meta/src/lib.rs` to generate `From<T>` (for 1 field) or `From<(T1, ..., TN)>` (for 2-3 fields) inplementations, delegating to the respective `fromN` methods.
    *   Step 3: Integrate these new functions into `variadic_from_derive` in `module/core/variadic_from_meta/src/lib.rs`.
    *   Step 4: Perform Increment Verification.
    *   Step 5: Perform Crate Conformance Check.
*   **Increment Verification:**
    *   Execute `timeout 90 cargo build -p variadic_from_meta` via `execute_command` and analyze output to ensure successful compilation of the macro crate with new implementations.
*   **Commit Message:** feat(variadic_from_meta): Implement core `FromN` and `From<Tuple>` generation

##### Increment 4: Implement Conditional Convenience `FromN` Generation
*   **Goal:** Add logic to `variadic_from_meta/src/lib.rs` to generate convenience `From1` (for 2-field and 3-field structs with identical types) and `From2` (for 3-field structs with last two fields identical) implementations based on type equality checks.
*   **Specification Reference:** `spec.md` v1.1 - "Convenience `FromN` Implementations"
*   **Steps:**
    *   Step 1: Implement `are_all_field_types_identical` and `are_field_types_identical_from` methods in `VariadicFromContext` to check for type equality.
    *   Step 2: Implement `generate_convenience_impls` function in `module/core/variadic_from_meta/src/lib.rs` to conditionally generate `From1` and `From2` implementations based on type identity.
    *   Step 3: Integrate `generate_convenience_impls` into `variadic_from_derive`.
    *   Step 4: Perform Increment Verification.
    *   Step 5: Perform Crate Conformance Check.
*   **Increment Verification:**
    *   Execute `timeout 90 cargo build -p variadic_from_meta` via `execute_command` and analyze output to ensure successful compilation of the macro crate with new implementations.
*   **Commit Message:** feat(variadic_from_meta): Implement conditional convenience `FromN` generation

##### Increment 5: Implement and Validate the New Test Suite
*   **Goal:** Create a comprehensive test suite for the `VariadicFrom` derive macro, covering all specified scenarios (field counts, types, generics, convenience implementations), and ensure all tests pass.
*   **Specification Reference:** `spec.md` v1.1 - "Test Cases"
*   **Steps:**
    *   Step 1: Create `module/core/variadic_from/tests/inc/derive_test.rs` and populate it with test cases for 1, 2, and 3-field named and tuple structs, including cases for identical and different field types, and generics.
    *   Step 2: Ensure `module/core/variadic_from/tests/inc/mod.rs` correctly includes `derive_test`.
    *   Step 3: Fix `E0061` error in `variadic_from_meta/src/lib.rs` by correcting `constructor_uniform` for tuple structs to repeat the single argument `self.num_fields` times.
    *   Step 4: Fix `E0382` errors in `derive_test.rs` by adding `.clone()` calls to `String` arguments where necessary to prevent move errors.
    *   Step 5: Fix `E0382` errors in `variadic_from_meta/src/lib.rs` by conditionally cloning `String` arguments in generated convenience `From2` implementations using a custom `is_type_string` helper.
    *   Step 6: Perform Increment Verification.
    *   Step 7: Perform Crate Conformance Check.
*   **Increment Verification:**
    *   Execute `timeout 90 cargo test -p variadic_from --test variadic_from_tests` via `execute_command` and analyze output to ensure all tests pass.
*   **Commit Message:** feat(variadic_from): Implement and validate new test suite for derive macro

##### Increment 6: Implement Compile-Fail Tests
*   **Goal:** Implement compile-fail tests using `trybuild` to verify that the `VariadicFrom` macro correctly produces compile errors for invalid input (e.g., structs with 0 or >3 fields, `from!` macro with too many arguments).
*   **Specification Reference:** `spec.md` v1.1 - "Compile-Fail Test Cases"
*   **Steps:**
    *   Step 1: Add `trybuild` as a dev-dependency to `module/core/variadic_from/Cargo.toml`.
    *   Step 2: Create a new test file (e.g., `module/core/variadic_from/tests/compile_fail.rs`) for `trybuild` tests.
    *   Step 3: Implement compile-fail test cases for structs with 0 fields, >3 fields, and `from!` macro with too many arguments.
    *   Step 4: Move generated `.stderr` files from `module/core/variadic_from/wip/` to `module/core/variadic_from/tests/compile_fail/`.
    *   Step 5: Perform Increment Verification.
    *   Step 6: Perform Crate Conformance Check.
*   **Increment Verification:**
    *   Execute `timeout 90 cargo test -p variadic_from --test compile_fail` via `execute_command` and analyze output to ensure `trybuild` tests pass.
*   **Commit Message:** test(variadic_from): Implement compile-fail tests for derive macro

##### Increment 7: Finalization
*   **Goal:** Perform a final, holistic review and verification of the entire task's output, including self-critique against all requirements, a full run of the Crate Conformance Check, and cleanup of temporary changes.
*   **Specification Reference:** N/A (Finalization)
*   **Steps:**
    *   Step 1: Self-critique: Review all changes against `Goal`, `Task Requirements`, and `Project Requirements`.
    *   Step 2: Run full Crate Conformance Check on all editable crates.
    *   Step 3: Perform Output Cleanliness Check.
    *   Step 4: Revert temporary change in `module/core/macro_tools/Cargo.toml` (remove `diag` from `enabled` feature list).
    *   Step 5: Ensure `git status` shows a clean working directory.
    *   Step 6: Update `module/core/variadic_from/changelog.md` with a summary of all completed increments.
    *   Step 7: Perform Increment Verification.
*   **Increment Verification:**
    *   Execute `timeout 90 cargo test --workspace` via `execute_command` to ensure all tests pass.
    *   Execute `timeout 90 cargo clippy --workspace -- -D warnings` via `execute_command` to ensure no linter warnings.
    *   Execute `cargo clean --workspace` followed by `timeout 90 cargo build --workspace` via `execute_command` and analyze output for any unexpected debug prints.
    *   Execute `git status` via `execute_command` to confirm a clean working directory.
*   **Commit Message:** chore(variadic_from): Finalize task and cleanup

### Task Requirements
*   The `VariadicFrom` derive macro must be implemented using `macro_tools`.
*   A comprehensive test suite must be created to validate the macro's behavior.
*   Compile-fail tests must be implemented for invalid macro usage.
*   All generated code must adhere to the specified `codestyle` rules.
*   The `macro_tools` dependency's `diag` feature must be temporarily enabled for local development and reverted in the final increment.

### Project Requirements
*   All code must strictly adhere to the `codestyle` rulebook provided by the user at the start of the task.
*   Must use Rust 2021 edition.
*   All new APIs must be async (if applicable).
*   All crates must have `[lints] workspace = true` in their `Cargo.toml`.
*   All dependencies must be centralized in `[workspace.dependencies]` in the root `Cargo.toml`.

### Assumptions
*   The `macro_tools` crate (version 0.5) is compatible with the current Rust toolchain.
*   The `diag` feature in `macro_tools` is necessary for `syn_err!` and `return_syn_err!` macros.
*   The `is_string` function is not directly exposed in `macro_tools::typ` and requires a custom helper.

### Out of Scope
*   Implementing `VariadicFrom` for enums.
*   Implementing `VariadicFrom` for structs with more than 3 fields (beyond compile-fail tests).
*   Extensive performance optimizations beyond `#[inline(always)]` where appropriate.

### External System Dependencies (Optional)
*   None.

### Notes & Insights
*   Initial attempts to patch `macro_tools` via `[patch.crates-io]` and `[replace]` in `Cargo.toml` were unsuccessful due to Cargo's behavior with local workspace dependencies. Direct modification of `macro_tools/Cargo.toml` was necessary as a temporary workaround.
*   The `E0061` error for tuple structs with identical fields was due to incorrect constructor generation in `constructor_uniform`.
*   The `E0382` errors for `String` types were due to missing `.clone()` calls in the generated code, requiring conditional cloning based on type.
*   The `macro_tools::typ::is_string` function was not resolved, necessitating a custom `is_type_string` helper.

### Changelog
* [Increment 6 | 2025-07-06 16:31 UTC] Refactored `module/core/variadic_from/tests/compile_fail.rs` to use `trybuild` correctly with separate test files.
* [Increment 6 | 2025-07-06 16:30 UTC] Created `module/core/variadic_from/tests/compile_fail.rs` with compile-fail test cases.
* [Increment 6 | 2025-07-06 16:30 UTC] Added `trybuild` as a dev-dependency to `module/core/variadic_from/Cargo.toml`.
* [Increment 5 | 2025-07-06 16:27 UTC] Implemented custom `is_type_string` helper in `variadic_from_meta/src/lib.rs` to replace unresolved `macro_tools::typ::is_string`.
* [Increment 5 | 2025-07-06 16:25 UTC] Corrected import for `is_string` in `variadic_from_meta/src/lib.rs`.
* [Increment 5 | 2025-07-06 16:24 UTC] Fixed `E0382` errors in `variadic_from_meta/src/lib.rs` by adding `.clone()` to repeated `String` arguments in generated convenience `From2` implementations.
* [Increment 5 | 2025-07-06 16:23 UTC] Re-added `.clone()` calls to `String` arguments in `derive_test.rs` to fix `E0382` errors.
* [Increment 5 | 2025-07-06 16:22 UTC] Fixed `E0061` error in `variadic_from_meta/src/lib.rs` by correcting `constructor_uniform` for tuple structs.
* [Increment 5 | 2025-07-06 16:20 UTC] Fixed `String` move errors in `derive_test.rs` by removing unnecessary `.clone()` calls.
* [Increment 4 | 2025-07-06 16:13 UTC] Implemented conditional convenience `FromN` generation.
* [Increment 3 | 2025-07-06 16:11 UTC] Implemented core `FromN` and `From<Tuple>` generation.
* [Increment 2 | 2025-07-06 16:07 UTC] Refactored macro input parsing using `macro_tools`.
* [Increment 1 | 2025-07-06 16:05 UTC] Initial audit, cleanup, and module restructuring.
