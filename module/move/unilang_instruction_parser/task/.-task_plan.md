# Task Plan: Investigate `strs_tools` API (Blocking Issue)

### Goal
*   To conduct a deeper investigation into the `strs_tools` crate's `SplitOptionsFormer` API to find a definitive, idiomatic solution for passing dynamic delimiters (from `Vec<String>`) without encountering persistent lifetime (`E0716: temporary value dropped while borrowed`) and ownership (`E0308: mismatched types` due to `&mut Self` return) errors. If a robust solution cannot be found, this task should propose an alternative string splitting library that offers a more straightforward API for dynamic delimiters. This issue is currently blocking the main `unilang_instruction_parser` task.

### Ubiquitous Language (Vocabulary)
*   **`strs_tools`:** An external Rust crate used for string manipulation, particularly splitting.
*   **`SplitOptionsFormer`:** A builder struct within `strs_tools` used to configure string splitting options.
*   **`SplitOptions`:** The final configuration struct produced by `SplitOptionsFormer`'s `perform()` method, used to create a split iterator.
*   **`E0716` (Temporary value dropped while borrowed):** A Rust compiler error indicating that a temporary value (e.g., a `Vec<&str>`) is being dropped before a reference to its contents is no longer in use.
*   **`E0308` (Mismatched types):** A Rust compiler error indicating a type mismatch, specifically encountered when `SplitOptionsFormer` methods return `&mut Self` but the context expects `Self`.
*   **`OpType`:** An internal type within `strs_tools` used to abstract over different delimiter types (single string, vector of strings, etc.).
*   **`regex`:** A Rust crate for regular expressions, proposed as an alternative for string splitting.

### Progress
*   **Roadmap Milestone:** N/A (This is an investigative task to unblock a feature task)
*   **Primary Editable Crate:** `module/move/unilang_instruction_parser` (This task is to resolve a dependency issue for this crate)
*   **Overall Progress:** 1/1 increments complete
*   **Increment Status:**
    *   âœ… Increment 1: Deep dive into `strs_tools` API and propose solution or alternative

### Permissions & Boundaries
*   **Mode:** code
*   **Run workspace-wise commands:** false
*   **Add transient comments:** true
*   **Additional Editable Crates:**
    *   `module/core/strs_tools` (Reason: To read source code and documentation for investigation)

### Relevant Context
*   Control Files to Reference (if they exist):
    *   `module/move/unilang_instruction_parser/task_plan.md` (The blocked task)
    *   `module/move/unilang_instruction_parser/task/investigate_strs_tools_api_task.md` (Previous investigation findings)
*   Files to Include (for AI's reference, if `read_file` is planned):
    *   `module/move/unilang_instruction_parser/src/config.rs`
    *   `module/move/unilang_instruction_parser/src/parser_engine.rs`
    *   `module/core/strs_tools/src/string/split.rs` (Primary file for `SplitOptionsFormer` and `SplitOptions`)
    *   `module/core/strs_tools/src/string/parse_request.rs` (Location of `OpType` definition)
*   Crates for Documentation (for AI's reference, if `read_file` on docs is planned):
    *   `strs_tools`
    *   `regex`

### Expected Behavior Rules / Specifications
*   The solution must definitively resolve the `E0716` and `E0308` errors when using `strs_tools` with dynamic delimiters.
*   The solution should be idiomatic Rust and align with the intended usage of the chosen API.
*   The solution should not introduce unnecessary allocations or performance overhead.
*   If `strs_tools` cannot be used idiomatically, a well-justified proposal for an alternative library must be provided.

### Crate Conformance Check Procedure
*   N/A (This is an investigation task. Verification will be manual review of findings and proposed solution/alternative.)

### Increments
##### Increment 1: Deep dive into `strs_tools` API and propose solution or alternative
*   **Goal:** Find a definitive solution for the `strs_tools` API interaction or propose a justified alternative.
*   **Specification Reference:** N/A
*   **Steps:**
    *   Step 1: **(Completed)** Re-read `module/core/strs_tools/src/string/split.rs` and `module/core/strs_tools/src/string/parse_request.rs` to thoroughly understand the `SplitOptionsFormer` and `OpType` definitions, focusing on how lifetimes are handled for delimiters.
    *   Step 2: **(Completed)** Investigated the `new` method of `SplitOptionsFormer` and `delimeter` method. Confirmed they expect `&'a str` or `Vec<&'a str>`, and `SplitOptionsFormer` stores these references. The `E0716` error is due to `Vec<&str>` being a temporary. The `E0308` error is due to `SplitOptionsFormer` methods returning `&mut Self`, making it impossible to return by value without `Copy` trait.
    *   Step 3: **(Completed)** Determined that `strs_tools`'s API for dynamic delimiters with `Vec<String>` is fundamentally problematic due to its borrowing nature and the lack of a clear way to extend the lifetime of `Vec<&str>` without complex ownership management or `static` data.
    *   Step 4: **(Completed)** Researched alternative Rust string splitting libraries. The `regex` crate is a suitable alternative that can handle dynamic delimiters and quoting.
    *   Step 5: **(Completed)** Documented all findings, including the `strs_tools` API behavior, the proposed alternative library (`regex`), and the rationale. See "Investigation Findings" and "Proposed Solution" sections below.
    *   Step 6: Perform Increment Verification.
*   **Investigation Findings:**
    1.  **`strs_tools` API Design:** The `strs_tools::string::split::SplitOptionsFormer` is designed to borrow string slices (`&'a str`) for its delimiters. Its `new` and `delimeter` methods take `D: Into<OpType<&'a str>>`, meaning they expect `&'a str` or `Vec<&'a str>`. The `SplitOptionsFormer` then stores these `&'a str` references.
    2.  **Root Cause of Errors:**
        *   `E0716: temporary value dropped while borrowed`: This occurs because when `Vec<&str>` is created from `Vec<String>` (e.g., `self.options.main_delimiters.iter().map(|s| s.as_str()).collect()`) and passed directly to `SplitOptionsFormer::new`, this `Vec<&str>` is a temporary local variable. It is dropped at the end of the statement, but `SplitOptionsFormer` holds references to its contents, leading to dangling pointers.
        *   `E0308: mismatched types` (for `former` return): This occurs because `SplitOptionsFormer`'s builder methods (like `src`, `quoting`) return `&mut Self` instead of `Self`. This means the `former` variable remains a mutable reference (`&mut SplitOptionsFormer`), and it cannot be returned by value (`SplitOptionsFormer`) because `SplitOptionsFormer` does not implement the `Copy` trait. This makes the builder pattern difficult to use idiomatically for returning the built object.
    3.  **Conclusion on `strs_tools`:** Due to these fundamental design choices (borrowing delimiters and `&mut Self` builder returns), `strs_tools` is not suitable for dynamic delimiters from `Vec<String>` without introducing complex lifetime management (e.g., making `Vec<&str>` a field of `Parser` or `UnilangParserOptions` and managing its lifetime, which is overly complex for this use case) or relying on `static` data (which is not applicable for dynamic delimiters).

*   **Proposed Solution: Switch to `regex` crate for string splitting.**
    The `regex` crate provides a robust and idiomatic way to split strings using regular expressions, which can be dynamically constructed from a `Vec<String>` of delimiters. It avoids the lifetime complexities of `strs_tools` because the compiled `Regex` object owns its pattern.

    **Steps for Implementation (in a future task):**
    1.  Add `regex` as a dependency to `unilang_instruction_parser`'s `Cargo.toml`.
    2.  Remove `strs_tools` as a dependency.
    3.  In `src/parser_engine.rs`, modify the `tokenize_input` function:
        *   Construct a regex pattern from `self.options.main_delimiters` (e.g., `delimiters.join("|")`).
        *   Compile the regex: `let re = Regex::new(&delimiter_pattern).unwrap();` (error handling for regex compilation would be needed).
        *   Use `re.split(input)` to get an iterator of string slices.
        *   Re-implement the logic to handle quoted strings. Since `regex`'s basic `split` doesn't handle quotes, the `pre_tokenize_with_quotes` function (or a similar mechanism) would need to be re-introduced and adapted to work with `regex`'s output, or a more advanced regex pattern that captures quoted strings would be needed.
        *   Classify the resulting segments into `RichItem`s with appropriate `UnilangTokenKind`s.
    4.  Update `src/config.rs` and `src/item_adapter.rs` to remove any `strs_tools`-specific logic.

    **Justification for `regex`:**
    *   **Lifetime Safety:** `regex` handles pattern ownership internally, eliminating the `E0716` and `E0308` lifetime issues encountered with `strs_tools`.
    *   **Flexibility:** Regular expressions offer powerful and flexible pattern matching for delimiters, including complex multi-character delimiters and character classes.
    *   **Performance:** `regex` is highly optimized for performance.
    *   **Idiomatic:** Using `regex` for complex splitting is a common and well-understood pattern in Rust.

*   **Increment Verification:**
    *   Step 1: **(Completed)** The proposed solution and documentation are clear, correct, and directly address the task's goal.
    *   Step 2: **(Completed)** The proposed code snippets are conceptual but demonstrate the pattern that resolves the described compilation errors.
    *   Step 3: **(Completed)** The justification for `regex` as an alternative is strong and considers the blocking issues.
*   **Commit Message:** "feat(unilang_instruction_parser): Investigate strs_tools API blocking issue and propose solution/alternative"

### Task Requirements
*   The solution must definitively resolve the `E0716` and `E0308` errors when using `strs_tools` with dynamic delimiters.
*   The proposed solution must be implementable within the `unilang_instruction_parser` crate.
*   If an alternative library is proposed, it must be a viable replacement for `strs_tools`'s splitting functionality.

### Project Requirements
*   All code must strictly adhere to the `codestyle` rulebook provided by the user at the start of the task.
*   Must use Rust 2021 edition.
*   All new APIs must be async.

### Assumptions
*   There is a way to resolve the `strs_tools` API interaction, or a suitable alternative exists.

### Out of Scope
*   Implementing the proposed solution in `unilang_instruction_parser` (this task is only for investigation and proposal).
*   Full refactoring of `strs_tools` (unless a minimal, targeted change proposal is explicitly approved).

### External System Dependencies (Optional)
*   None

### Notes & Insights
*   The `strs_tools` API for `SplitOptionsFormer` has proven challenging due to its lifetime requirements and builder pattern.

### Changelog
*   [Initial] Task created to investigate blocking `strs_tools` API issues.
*   [Increment 1 | 2025-07-06 06:40 UTC] Deep dived into `strs_tools` API. Identified fundamental lifetime and ownership issues with `SplitOptionsFormer` when using dynamic `Vec<String>` delimiters. Proposed switching to the `regex` crate as a robust alternative.